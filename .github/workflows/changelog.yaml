name: 'ðŸ“ Create/Update Release Draft & Release Bump PR'

on:
  push:
    branches:
      - master
    paths-ignore:
      - build.yaml
  workflow_dispatch:
  repository_dispatch:
    types:
      - update-prep-command

permissions:
  contents: write
  pull-requests: write

jobs:
  call:
    uses: jellyfin/jellyfin-meta-plugins/.github/workflows/changelog.yaml@master
    with:
      repository-name: JPKribs/jellyfin-plugin-episodepostergenerator
    secrets:
      token: ${{ secrets.GITHUB_TOKEN }}

  build-and-attach:
    needs: call
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Build Plugin
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Get Build Info
        id: build_info
        run: |
          BUILD_VERSION=$(grep '^version:' build.yaml | sed 's/version: *"\?\([^"]*\)"\?.*/\1/' | tr -d '"')
          echo "build_version=${BUILD_VERSION}" >> $GITHUB_OUTPUT

      - name: Get Latest Draft Release
        id: release
        run: |
          RELEASE_TAG=$(gh release list --limit 1 --json tagName,isDraft --jq '.[] | select(.isDraft == true) | .tagName')
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Release Tag and Body
        if: steps.release.outputs.release_tag != ''
        run: |
          CORRECT_TAG="v${{ steps.build_info.outputs.build_version }}"

          # Extract changelog using Python for better YAML parsing
          CHANGELOG=$(python3 << 'PYEOF'
          import yaml

          with open('build.yaml', 'r') as f:
              data = yaml.safe_load(f)

          changelog = data.get('changelog', {})
          output = []

          for category, items in changelog.items():
              if isinstance(items, list):
                  output.append(f"\n## {category.capitalize()}")
                  for item in items:
                      output.append(f"- {item}")

          print('\n'.join(output))
          PYEOF
          )

          # Use gh release edit
          gh release edit "${{ steps.release.outputs.release_tag }}" \
            --tag "${CORRECT_TAG}" \
            --title "${CORRECT_TAG}" \
            --notes "${CHANGELOG}"

          echo "Updated release tag to: ${CORRECT_TAG}"
          echo "updated_tag=${CORRECT_TAG}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: update_release

      - name: Upload Assets to Draft Release
        if: steps.release.outputs.release_tag != ''
        run: |
          # Use the updated tag name
          UPLOAD_TAG="${{ steps.update_release.outputs.updated_tag || steps.release.outputs.release_tag }}"

          # Delete old assets if they exist to avoid conflicts
          gh release view "${UPLOAD_TAG}" --json assets --jq '.assets[].name' | while read asset; do
            if [[ "$asset" == *"jellyfin-plugin-episodepostergenerator"* ]]; then
              echo "Deleting old asset: $asset"
              gh release delete-asset "${UPLOAD_TAG}" "$asset" -y || true
            fi
          done

          # Upload new assets
          gh release upload "${UPLOAD_TAG}" \
            ./dist/jellyfin-plugin-episodepostergenerator-${{ steps.build_info.outputs.build_version }}.zip \
            ./dist/jellyfin-plugin-episodepostergenerator-${{ steps.build_info.outputs.build_version }}.zip.md5 \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}